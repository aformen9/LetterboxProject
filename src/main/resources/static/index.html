<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Letterbox Project</title>
    <style>
        .stars { display: inline-flex; gap: 4px; cursor: pointer; }
        .star {
        font-size: 20px; user-select: none; transition: transform .08s ease;
        }
        .star:hover { transform: scale(1.1); }
        .star.active { text-shadow: 0 0 6px rgba(255,215,0,.5); }
        .review-meta { opacity:.85; font-size: 12px; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:#14181c; color:#fff; margin:0; padding:20px; }
        h1, h2 { color:#00c030; border-bottom:2px solid #445566; padding-bottom:10px; }
        .container { max-width:900px; margin:auto; }
        .movie-list, .review-list { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; }
        .movie-card, .review-card { background:#2c3440; border-radius:8px; padding:15px; box-shadow:0 4px 8px rgba(0,0,0,.2); }
        .movie-card h3 { margin-top:0; }
        .review-card p { margin:5px 0; }
        .review-card .rating { font-weight:bold; color:#00e054; }
        form { background:#2c3440; padding:20px; border-radius:8px; margin-top:20px; }
        form input, form textarea, form select { width:calc(100% - 20px); padding:10px; margin-bottom:10px; border-radius:4px; border:1px solid #445566; background:#1f252c; color:#fff; }
        form button { background:#00c030; color:#fff; padding:10px 15px; border:none; border-radius:4px; cursor:pointer; font-size:16px; }
        form button:hover { background:#00e054; }
        .error { color:#ffa8a8; margin-top:8px; }
    </style>
</head>
<body>
<div class="container">
    <h1>üé¨ Letterbox Project</h1>

    <h2>Pel√≠culas</h2>
    <div id="movie-list" class="movie-list"></div>

    <h2>Usuario</h2>
    <div id="user-box" class="user-box">
        <label for="user-select">Seleccion√° usuario:</label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <select id="user-select"></select>
            <button id="set-user-btn" type="button">Usar usuario</button>
            <span id="current-user-label" style="opacity:.85;"></span>
        </div>

        <details style="margin-top:8px;">
            <summary>¬øNo existe tu usuario? Crear uno r√°pido</summary>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <input id="new-username" type="text" placeholder="username (√∫nico)">
                <input id="new-displayname" type="text" placeholder="nombre a mostrar (opcional)">
                <button id="create-user-btn" type="button">Crear</button>
                <span id="create-user-msg" style="opacity:.85;"></span>
            </div>
        </details>
    </div>


    <h2>A√±adir Nueva Rese√±a</h2>
    <form id="review-form">
        <label for="movie-select">Selecciona una pel√≠cula:</label>
        <select id="movie-select" required>
            <option value="" disabled selected>Seleccion√°...</option>
        </select>

        <label for="reviewer-name">Tu Nombre:</label>
        <input type="text" id="reviewer-name" required />

        <label for="rating">Calificaci√≥n (1-5):</label>
        <input type="number" id="rating" min="1" max="5" step="0.5" required />

        <label for="comment">Comentario:</label>
        <textarea id="comment" rows="4" required></textarea>

        <button type="submit">Enviar Rese√±a</button>
        <div id="form-error" class="error" style="display:none;"></div>
    </form>

    <h2>√öltimas Rese√±as</h2>
    <div id="review-list" class="review-list"></div>
</div>

<script>
    // ========= Endpoints =========
    const MOVIE_API  = '/api/movies';
    const REVIEW_API = '/api/reviews';
    const USERS_API  = '/api/users';

    // ========= Refs UI =========
    const movieList   = document.getElementById('movie-list');
    const reviewList  = document.getElementById('review-list');
    const movieSelect = document.getElementById('movie-select');
    const reviewForm  = document.getElementById('review-form');

    // Usuario UI
    const userSelect        = document.getElementById('user-select');
    const setUserBtn        = document.getElementById('set-user-btn');
    const currentUserLabel  = document.getElementById('current-user-label');
    const newUsernameInput  = document.getElementById('new-username');
    const newDisplayInput   = document.getElementById('new-displayname');
    const createUserBtn     = document.getElementById('create-user-btn');
    const createUserMsg     = document.getElementById('create-user-msg');

    // ========= Estado =========
    let currentUserId = Number(localStorage.getItem('currentUserId') || 0);

    // ========= Users =========
    async function loadUsers() {
      try {
        const res = await fetch(USERS_API);
        const users = await res.json();
        userSelect.innerHTML = users.map(u =>
          `<option value="${u.id}">${u.displayName || u.username} (id:${u.id})</option>`
        ).join('');

        // Si ya hab√≠a user elegido, refl√©jalo en el UI
        if (currentUserId) {
          const opt = [...userSelect.options].find(o => Number(o.value) === currentUserId);
          if (opt) userSelect.value = String(currentUserId);
        }
        refreshCurrentUserLabel();
      } catch (e) {
        console.error('Error cargando usuarios', e);
        userSelect.innerHTML = '<option value="">(error)</option>';
      }
    }

    function refreshCurrentUserLabel() {
      currentUserLabel.textContent = currentUserId
        ? `Usuario actual: ${userSelect.selectedOptions[0]?.textContent || '(id:'+currentUserId+')'}`
        : `Ning√∫n usuario elegido`;
    }

    setUserBtn?.addEventListener('click', () => {
      const chosen = Number(userSelect.value);
      if (!chosen) { alert('Eleg√≠ un usuario'); return; }
      currentUserId = chosen;
      localStorage.setItem('currentUserId', String(currentUserId));
      refreshCurrentUserLabel();
    });

    createUserBtn?.addEventListener('click', async () => {
      const username = (newUsernameInput.value || '').trim();
      const display  = (newDisplayInput.value || '').trim();
      if (!username) { createUserMsg.textContent = 'username requerido'; return; }
      createUserMsg.textContent = 'Creando...';
      try {
        const res = await fetch(USERS_API, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ username, displayName: display })
        });
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || 'Error creando usuario');
        }
        newUsernameInput.value = '';
        newDisplayInput.value = '';
        createUserMsg.textContent = 'Usuario creado ‚úÖ';
        await loadUsers();
      } catch (e) {
        console.error(e);
        createUserMsg.textContent = 'Error: ' + e.message;
      } finally {
        setTimeout(() => { createUserMsg.textContent = ''; }, 1800);
      }
    });

    // ========= Movies =========
    async function loadMovies() {
      try {
        const response = await fetch(MOVIE_API);
        const movies = await response.json();

        movieList.innerHTML = '';
        movieSelect.innerHTML = '';

        movies.forEach(movie => {
          const movieCard = document.createElement('div');
          movieCard.className = 'movie-card';
          movieCard.innerHTML = `
            <h3>${movie.title} (${movie.releaseYear ?? movie.year ?? ''})</h3>
            <p><strong>Director:</strong> ${movie.director || '-'}</p>
            <p><em>${movie.synopsis || ''}</em></p>
          `;
          movieList.appendChild(movieCard);

          const option = document.createElement('option');
          option.value = movie.id;
          option.textContent = movie.title;
          movieSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error cargando pel√≠culas:', error);
        movieList.innerHTML = '<p>No se pudieron cargar las pel√≠culas.</p>';
        movieSelect.innerHTML = '<option value="">(error)</option>';
      }
    }

    // ========= Reviews + Stars =========
    async function fetchReviewSummary(reviewId) {
      const res = await fetch(`${REVIEW_API}/${reviewId}/ratings/summary`);
      if (!res.ok) return { average: 0, count: 0 };
      return await res.json(); // {reviewId, average, count}
    }

    function buildStars(reviewId, currentAvg) {
      // Render 5 estrellas. No pintamos por promedio exacto (puede ser 4.3),
      // s√≥lo marcamos activas si >= i redondeado (opcional).
      const container = document.createElement('div');
      container.className = 'stars';
      const rounded = Math.round(currentAvg || 0);

      for (let i = 1; i <= 5; i++) {
        const span = document.createElement('span');
        span.className = 'star' + (i <= rounded ? ' active' : '');
        span.textContent = '‚òÖ';
        span.title = `Puntuar ${i}/5`;
        span.addEventListener('click', async () => {
          if (!currentUserId) { alert('Eleg√≠ o cre√° un usuario primero.'); return; }
          try {
            // POST /api/reviews/{id}/ratings { userId, value }
            const res = await fetch(`${REVIEW_API}/${reviewId}/ratings`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ userId: currentUserId, value: i })
            });
            if (!res.ok) throw new Error(await res.text());
            // refrescar s√≥lo este bloque: promedio + estrellas
            const summary = await fetchReviewSummary(reviewId);
            updateStarsBlock(container.parentElement, reviewId, summary);
          } catch (e) {
            console.error(e);
            alert('No se pudo registrar tu voto: ' + e.message);
          }
        });
        container.appendChild(span);
      }
      return container;
    }

    function updateStarsBlock(wrapper, reviewId, summary) {
      // wrapper contiene .stars + .review-meta; regenero ambas
      const starsNode = wrapper.querySelector('.stars');
      const metaNode  = wrapper.querySelector('.review-meta');
      if (starsNode) starsNode.replaceWith(buildStars(reviewId, summary.average));
      if (metaNode)  metaNode.textContent = `Promedio: ${Number(summary.average || 0).toFixed(2)} (${summary.count} votos)`;
    }

    async function loadReviews() {
      try {
        const response = await fetch(REVIEW_API);
        const reviews = await response.json();

        reviewList.innerHTML = '';
        for (const review of reviews) {
          const card = document.createElement('div');
          card.className = 'review-card';
          card.innerHTML = `
            <p class="rating">‚òÖ ${review.rating}</p>
            <p><strong>${review.reviewerName}</strong> coment√≥:</p>
            <p>"${review.comment}"</p>
            <small>${new Date(review.reviewDate).toLocaleDateString()}</small>
            <div class="stars-wrapper" style="margin-top:8px;">
              <!-- ac√° van estrellas + meta -->
              <div class="review-meta">Cargando valoraci√≥n...</div>
            </div>
          `;
          reviewList.appendChild(card);

          // Traer summary y renderizar estrellas
          try {
            const summary = await fetchReviewSummary(review.id);
            const wrapper = card.querySelector('.stars-wrapper');
            wrapper.prepend(buildStars(review.id, summary.average));
            const meta = wrapper.querySelector('.review-meta');
            meta.textContent = `Promedio: ${Number(summary.average || 0).toFixed(2)} (${summary.count} votos)`;
          } catch (e) {
            console.warn('No se pudo cargar summary para review', review.id);
          }
        }
      } catch (error) {
        console.error('Error cargando rese√±as:', error);
        reviewList.innerHTML = '<p>No se pudieron cargar las rese√±as.</p>';
      }
    }

    // ========= Crear rese√±a (ya lo ten√≠as, s√≥lo arregl√© movieId) =========
    reviewForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newReview = {
        movieId: Number(document.getElementById('movie-select').value),
        reviewerName: document.getElementById('reviewer-name').value,
        rating: parseFloat(document.getElementById('rating').value),
        comment: document.getElementById('comment').value,
        isFavorite: false
      };
      try {
        const res = await fetch(REVIEW_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newReview)
        });
        if (!res.ok) throw new Error(await res.text());
        reviewForm.reset();
        await loadReviews();
      } catch (error) {
        console.error('Error al enviar la rese√±a:', error);
        alert('No se pudo crear la rese√±a: ' + error.message);
      }
    });

    // ========= Init =========
    document.addEventListener('DOMContentLoaded', async () => {
      await loadUsers();
      await loadMovies();
      await loadReviews();
    });
</script>
